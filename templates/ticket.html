<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>{{ ticket.title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='ticket.css') }}">
</head>
<body>
    <p><a href="/">‚Üê Back to tickets</a></p>

    <h1>{{ ticket.title }}</h1>
    <p><strong>Severity:</strong> {{ ticket.severity }}</p>
    <p><strong>Symptoms:</strong> {{ ticket.symptoms }}</p>
    <p><strong>Steps to reproduce:</strong> {{ ticket.steps_to_reproduce }}</p>
    <p><strong>Environment:</strong> {{ ticket.environment }}</p>

    <!-- Metrics Section -->
    {% if metrics %}
    <div class="log-section">
        <h2>Performance Metrics</h2>
        
        <!-- Auto-detected Issues -->
        {% if issues %}
        <div class="issues-container">
            <h3>üö® Auto-Detected Issues</h3>
            {% for issue in issues %}
            <div class="issue-card severity-{{ issue.severity }}">
                <span class="issue-severity">{{ issue.severity|upper }}</span>
                <strong>{{ issue.component }}</strong>: {{ issue.issue }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- Raw Metrics Display -->
        <details>
            <summary style="cursor: pointer; font-weight: bold; margin-top: 20px;">üìä View Raw Metrics</summary>
            <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto;">{{ metrics | tojson(indent=2) }}</pre>
        </details>
    </div>
    {% endif %}

    <!-- Resolution Form Section -->
    <div class="log-section">
        <h2>üìù Document Resolution</h2>
        
        {% if resolutions %}
        <div class="resolutions-history">
            <h3>Previous Resolutions</h3>
            {% for res in resolutions %}
            <div class="resolution-card">
                <div class="resolution-header">
                    <strong>Resolved by {{ res.resolved_by }}</strong>
                    <span class="resolution-date">{{ res.resolved_at }}</span>
                </div>
                <p><strong>Root Cause:</strong> {{ res.root_cause }}</p>
                <p><strong>Solution:</strong> {{ res.solution }}</p>
                {% if res.prevention %}
                <p><strong>Prevention:</strong> {{ res.prevention }}</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <form method="POST" class="resolution-form">
            <div class="form-group">
                <label for="root_cause">Root Cause Analysis *</label>
                <textarea 
                    id="root_cause" 
                    name="root_cause" 
                    required 
                    rows="3"
                    placeholder="What caused this issue? (e.g., Redis connection pool exhaustion due to memory leak in session manager)"
                ></textarea>
            </div>
            
            <div class="form-group">
                <label for="solution">Solution Implemented *</label>
                <textarea 
                    id="solution" 
                    name="solution" 
                    required 
                    rows="4"
                    placeholder="What steps did you take to resolve it? (e.g., 1. Restarted Redis service, 2. Increased connection pool size from 50 to 100, 3. Applied memory leak patch)"
                ></textarea>
            </div>
            
            <div class="form-group">
                <label for="prevention">Prevention Strategy</label>
                <textarea 
                    id="prevention" 
                    name="prevention" 
                    rows="3"
                    placeholder="How can we prevent this in the future? (e.g., Add Redis connection monitoring alerts, implement connection pool auto-scaling)"
                ></textarea>
            </div>
            
            <div class="form-group">
                <label for="resolved_by">Resolved By *</label>
                <input 
                    type="text" 
                    id="resolved_by" 
                    name="resolved_by" 
                    required 
                    placeholder="Your name"
                />
            </div>
            
            <button type="submit" class="submit-btn">Save Resolution</button>
        </form>
    </div>

    <!-- Log Viewer Section -->
    <div class="log-section">
        <h2>Application Logs</h2>
        
        <div class="log-filters">
            <strong>Filter by level:</strong>
            <a href="/tickets/{{ ticket.id }}" class="{% if not current_filter %}active{% endif %}">All</a>
            <a href="/tickets/{{ ticket.id }}?level=ERROR" class="{% if current_filter == 'ERROR' %}active{% endif %}">ERROR</a>
            <a href="/tickets/{{ ticket.id }}?level=WARN" class="{% if current_filter == 'WARN' %}active{% endif %}">WARN</a>
            <a href="/tickets/{{ ticket.id }}?level=INFO" class="{% if current_filter == 'INFO' %}active{% endif %}">INFO</a>
        </div>

        {% if logs %}
            <div class="log-container">
                {% for log in logs %}
                <div class="log-entry {{ log.level }}">
                    <span class="log-timestamp">{{ log.timestamp }}</span>
                    <span class="log-level {{ log.level }}">{{ log.level }}</span>
                    <span class="log-message">{{ log.message }}</span>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p style="color: #6c757d; font-style: italic;">No logs available for this ticket.</p>
        {% endif %}
    </div>
</body>
</html>